import Script from 'next/script';

const styles = "* {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background: #1a1a1a;\n            color: #ffffff;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 100vh;\n        }\n        .container {\n            text-align: center;\n            max-width: 600px;\n            padding: 40px;\n        }\n        h1 {\n            font-size: 24px;\n            margin-bottom: 15px;\n        }\n        .status {\n            display: inline-block;\n            padding: 8px 16px;\n            border-radius: 20px;\n            font-size: 14px;\n            margin-bottom: 20px;\n        }\n        .status.active {\n            background: #28a745;\n            color: white;\n        }\n        .status.inactive {\n            background: #6c757d;\n            color: white;\n        }\n        .pulse {\n            width: 12px;\n            height: 12px;\n            border-radius: 50%;\n            background: #28a745;\n            display: inline-block;\n            margin-right: 8px;\n            animation: pulse 2s infinite;\n        }\n        @keyframes pulse {\n            0%, 100% { opacity: 1; }\n            50% { opacity: 0.3; }\n        }\n        .log {\n            background: #2a2a2a;\n            border-radius: 8px;\n            padding: 20px;\n            margin-top: 20px;\n            max-height: 300px;\n            overflow-y: auto;\n            text-align: left;\n        }\n        .log-entry {\n            padding: 8px;\n            margin-bottom: 4px;\n            font-size: 13px;\n            font-family: monospace;\n            border-left: 3px solid #007bff;\n            background: #333;\n            border-radius: 3px;\n        }\n        .log-entry.success {\n            border-color: #28a745;\n        }\n        .instructions {\n            color: #aaa;\n            font-size: 14px;\n            line-height: 1.6;\n            margin-bottom: 20px;\n        }\n        .instructions strong {\n            color: #fff;\n        }\n        code {\n            background: #2a2a2a;\n            padding: 2px 6px;\n            border-radius: 3px;\n            font-family: monospace;\n        }\n        button {\n            padding: 10px 20px;\n            background: #007bff;\n            color: white;\n            border: none;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 14px;\n            margin: 5px;\n        }\n        button:hover {\n            background: #0056b3;\n        }\n        .btn-danger {\n            background: #dc3545;\n        }\n        .btn-danger:hover {\n            background: #c82333;\n        }";
const bodyHtml = "<div class=\"container\">\n        <h1>\ud83d\ude80 Auto Label Editor Launcher</h1>\n\n        <div id=\"status\" class=\"status active\">\n            <span class=\"pulse\"></span>\n            <span id=\"statusText\">Active & Monitoring</span>\n        </div>\n\n        <div class=\"instructions\">\n            <p><strong>Keep this tab open!</strong></p>\n            <p>When you run the <code>Edit Label in Tool</code> operator in FiftyOne, the label editor will automatically open in a new tab.</p>\n            <p style=\"margin-top: 10px;\">No copy/paste needed - it just works!</p>\n        </div>\n\n        <div>\n            <button onclick=\"testOpen()\">Test Open Editor</button>\n            <button class=\"btn-danger\" onclick=\"clearLog()\">Clear Log</button>\n        </div>\n\n        <div class=\"log\" id=\"log\">\n            <div class=\"log-entry\">Launcher started. Waiting for FiftyOne operator...</div>\n        </div>\n    </div>\n\n    <script>\n        const STORAGE_KEY = 'fiftyone_edit_label_request';\n        let lastRequest = null;\n\n        function log(message, isSuccess = false) {\n            const logDiv = document.getElementById('log');\n            const entry = document.createElement('div');\n            entry.className = 'log-entry' + (isSuccess ? ' success' : '');\n            const timestamp = new Date().toLocaleTimeString();\n            entry.textContent = `[${timestamp}] ${message}`;\n            logDiv.insertBefore(entry, logDiv.firstChild);\n\n            // Keep only last 20 entries\n            while (logDiv.children.length > 20) {\n                logDiv.removeChild(logDiv.lastChild);\n            }\n        }\n\n        async function openEditor(imagePath, labelPath, managerPort) {\n            // Construct the label editor URL using config from server\n            const config = await getConfig();\n            const protocol = window.location.protocol;\n            const publicAddress = config.publicAddress || window.location.hostname;\n            const port = config.managerPort || managerPort || '5000';\n\n            const editorUrl = `${protocol}//${publicAddress}:${port}/label-editor?image=${encodeURIComponent(imagePath)}&label=${encodeURIComponent(labelPath)}`;\n\n            // Open in new tab\n            const newWindow = window.open(editorUrl, '_blank');\n\n            if (!newWindow) {\n                log('\u274c Failed to open editor - popup blocked?');\n                return false;\n            }\n\n            const filename = imagePath.split('/').pop();\n            log(`\u2705 Opened editor for ${filename}`, true);\n            return true;\n        }\n\n        async function getConfig() {\n            try {\n                const response = await fetch('/api/config');\n                return await response.json();\n            } catch (error) {\n                log(`\u26a0\ufe0f Could not fetch config, using defaults: ${error.message}`);\n                return { publicAddress: window.location.hostname, managerPort: '5000' };\n            }\n        }\n\n        function checkForRequests() {\n            try {\n                const stored = localStorage.getItem(STORAGE_KEY);\n                if (!stored) return;\n\n                const request = JSON.parse(stored);\n\n                // Check if this is a new request (different from last one)\n                if (JSON.stringify(request) === lastRequest) {\n                    return;\n                }\n\n                lastRequest = JSON.stringify(request);\n\n                // Open the editor\n                log(`\ud83d\udce5 Received request: ${request.filename}`);\n                openEditor(request.image_path, request.label_path, request.manager_port);\n\n                // Clear the request after processing\n                localStorage.removeItem(STORAGE_KEY);\n\n            } catch (error) {\n                log(`\u274c Error: ${error.message}`);\n            }\n        }\n\n        async function testOpen() {\n            // Get config from server\n            const config = await getConfig();\n\n            // Test with dummy data\n            const testData = {\n                image_path: '/data/datasets/test/images/test.jpg',\n                label_path: '/data/datasets/test/labels/test.txt',\n                manager_port: config.managerPort || '5000',\n                filename: 'test.jpg',\n                timestamp: Date.now()\n            };\n\n            localStorage.setItem(STORAGE_KEY, JSON.stringify(testData));\n            log(`\ud83e\uddea Test request sent (port: ${testData.manager_port})`);\n        }\n\n        function clearLog() {\n            document.getElementById('log').innerHTML = '<div class=\"log-entry\">Log cleared.</div>';\n        }\n\n        // Check for requests every 500ms\n        setInterval(checkForRequests, 500);\n\n        // Also listen for storage events (when changed by another tab)\n        window.addEventListener('storage', (e) => {\n            if (e.key === STORAGE_KEY && e.newValue) {\n                checkForRequests();\n            }\n        });\n\n        log('\ud83c\udfaf Monitoring for FiftyOne operator requests...');\n    </script>";

export const metadata = {
  title: "Auto Label Editor Launcher"
};

export default function Page() {
  return (
    <>
      <style dangerouslySetInnerHTML={{ __html: styles }} />
      <div dangerouslySetInnerHTML={{ __html: bodyHtml }} />
      <Script src="/js/auto-launcher.js" strategy="afterInteractive" />
    </>
  );
}
