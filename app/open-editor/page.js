import Script from 'next/script';

const styles = "body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background: #1a1a1a;\n            color: #ffffff;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 100vh;\n            margin: 0;\n        }\n        .container {\n            text-align: center;\n            padding: 40px;\n        }\n        .spinner {\n            border: 4px solid #333;\n            border-top: 4px solid #007bff;\n            border-radius: 50%;\n            width: 50px;\n            height: 50px;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 20px;\n        }\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        h1 {\n            font-size: 24px;\n            margin-bottom: 10px;\n        }\n        p {\n            color: #aaa;\n            margin-bottom: 20px;\n        }\n        .manual-link {\n            display: none;\n            margin-top: 20px;\n        }\n        .manual-link a {\n            color: #007bff;\n            text-decoration: none;\n            padding: 10px 20px;\n            border: 1px solid #007bff;\n            border-radius: 4px;\n            display: inline-block;\n        }\n        .manual-link a:hover {\n            background: #007bff;\n            color: white;\n        }";
const bodyHtml = "<div class=\"container\">\n        <div class=\"spinner\"></div>\n        <h1>Opening Label Editor...</h1>\n        <p id=\"status\">Please wait...</p>\n        <div class=\"manual-link\" id=\"manualLink\">\n            <p>If the editor doesn't open automatically:</p>\n            <a id=\"editorLink\" href=\"#\" target=\"_blank\">Click here to open Label Editor</a>\n        </div>\n    </div>\n\n    <script>\n        async function getConfig() {\n            try {\n                const response = await fetch('/api/config');\n                return await response.json();\n            } catch (error) {\n                console.error('Could not fetch config:', error);\n                return { publicAddress: window.location.hostname, managerPort: '5000' };\n            }\n        }\n\n        async function openEditor() {\n            // Get URL parameters\n            const urlParams = new URLSearchParams(window.location.search);\n            const imagePath = urlParams.get('image');\n            const labelPath = urlParams.get('label');\n\n            if (!imagePath || !labelPath) {\n                document.getElementById('status').textContent = 'Error: Missing image or label path';\n                return;\n            }\n\n            // Get config from server\n            const config = await getConfig();\n            const protocol = window.location.protocol;\n            const publicAddress = config.publicAddress || window.location.hostname;\n            const managerPort = config.managerPort || '5000';\n\n            // Construct the label editor URL\n            const editorUrl = `${protocol}//${publicAddress}:${managerPort}/label-editor?image=${encodeURIComponent(imagePath)}&label=${encodeURIComponent(labelPath)}`;\n\n            document.getElementById('status').textContent = `Opening editor at ${publicAddress}:${managerPort}...`;\n\n            // Set the manual link\n            const manualLink = document.getElementById('editorLink');\n            manualLink.href = editorUrl;\n\n            // Try to open automatically\n            try {\n                const newWindow = window.open(editorUrl, '_blank');\n\n                // Check if popup was blocked\n                setTimeout(() => {\n                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {\n                        // Popup was blocked, show manual link\n                        document.getElementById('status').textContent = 'Popup blocked - please click the link below:';\n                        document.getElementById('manualLink').style.display = 'block';\n                    } else {\n                        // Success! Close this tab after a moment\n                        document.getElementById('status').textContent = 'Editor opened! You can close this tab.';\n                        setTimeout(() => {\n                            window.close();\n                        }, 2000);\n                    }\n                }, 500);\n            } catch (error) {\n                // Error opening window, show manual link\n                document.getElementById('status').textContent = 'Error opening editor - please click the link below:';\n                document.getElementById('manualLink').style.display = 'block';\n            }\n        }\n\n        // Run on page load\n        openEditor();\n    </script>";

export const metadata = {
  title: "Opening Label Editor..."
};

export default function Page() {
  return (
    <>
      <style dangerouslySetInnerHTML={{ __html: styles }} />
      <div dangerouslySetInnerHTML={{ __html: bodyHtml }} />
      <Script src="/js/open-editor.js" strategy="afterInteractive" />
    </>
  );
}
