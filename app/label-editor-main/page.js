import Script from 'next/script';

const styles = "* {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n            background: #141414;\n            color: #f3f3f3;\n            min-height: 100vh;\n            display: flex;\n            flex-direction: column;\n        }\n\n        header {\n            padding: 20px 28px;\n            background: #1f1f1f;\n            border-bottom: 1px solid #2a2a2a;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n        }\n\n        header h1 {\n            font-size: 20px;\n            font-weight: 600;\n        }\n\n        .btn {\n            background: #2b6cb0;\n            color: #fff;\n            border: none;\n            border-radius: 6px;\n            padding: 8px 14px;\n            font-size: 13px;\n            cursor: pointer;\n            transition: background 0.2s ease;\n        }\n\n        .btn:hover {\n            background: #1e4f82;\n        }\n\n        .btn.secondary {\n            background: #3a3a3a;\n        }\n\n        .btn.secondary:hover {\n            background: #505050;\n        }\n\n        .btn:disabled {\n            background: #2a2a2a;\n            color: #777;\n            cursor: not-allowed;\n        }\n\n        main {\n            flex: 1;\n            padding: 24px 28px;\n        }\n\n        .status {\n            font-size: 13px;\n            color: #a0a0a0;\n            margin-bottom: 16px;\n        }\n\n        .grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));\n            gap: 16px;\n        }\n\n        .card {\n            background: #1d1d1d;\n            border: 1px solid #2a2a2a;\n            border-radius: 10px;\n            padding: 16px;\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n\n        .card h2 {\n            font-size: 16px;\n            font-weight: 600;\n        }\n\n        .meta {\n            font-size: 12px;\n            color: #b0b0b0;\n            line-height: 1.4;\n            word-break: break-all;\n        }\n\n        .pill {\n            display: inline-flex;\n            align-items: center;\n            gap: 6px;\n            font-size: 11px;\n            padding: 4px 8px;\n            border-radius: 999px;\n            background: #2a2a2a;\n            color: #cfcfcf;\n        }\n\n        .pill .dot {\n            width: 6px;\n            height: 6px;\n            border-radius: 50%;\n            background: #9a9a9a;\n        }\n\n        .pill.online .dot {\n            background: #2ecc71;\n        }\n\n        .pill.offline .dot {\n            background: #e74c3c;\n        }\n\n        .actions {\n            display: flex;\n            gap: 8px;\n            flex-wrap: wrap;\n        }\n\n        .empty-state {\n            text-align: center;\n            color: #9a9a9a;\n            padding: 40px 0;\n        }";
const bodyHtml = "<header>\n        <h1>Label Editor Datasets</h1>\n        <button class=\"btn secondary\" onclick=\"refreshInstances()\">Refresh</button>\n    </header>\n\n    <main>\n        <div class=\"status\" id=\"statusText\">Loading instances...</div>\n        <div class=\"grid\" id=\"instancesGrid\"></div>\n        <div class=\"empty-state\" id=\"emptyState\" style=\"display: none;\">\n            No instances found. Create an instance in the manager first.\n        </div>\n    </main>\n\n    <script>\n        const API_BASE = window.location.origin;\n        let instances = [];\n        let config = {};\n\n        function setStatus(text) {\n            const status = document.getElementById('statusText');\n            if (status) {\n                status.textContent = text;\n            }\n        }\n\n        function normalizeDatasetPath(datasetPath) {\n            return (datasetPath || '').replace(/\\/+$/, '');\n        }\n\n        function buildEditorUrl(datasetPath, lastImagePath) {\n            const normalized = normalizeDatasetPath(datasetPath);\n            if (!normalized) {\n                return '';\n            }\n            const basePath = config.datasetBasePath || '/data/datasets';\n            const relativePath = normalized.startsWith(basePath)\n                ? normalized.slice(basePath.length).replace(/^\\/+/, '')\n                : '';\n            const folderPath = relativePath ? `${relativePath}/images` : 'images';\n            const normalizedStart = normalizeStartImagePath(lastImagePath, folderPath);\n            const startParam = normalizedStart ? `&start=${encodeURIComponent(normalizedStart)}` : '';\n            return `${window.location.origin}/label-editor?base=${encodeURIComponent(basePath)}&folder=${encodeURIComponent(folderPath)}${startParam}`;\n        }\n\n        async function openLabelEditor(datasetPath, lastImagePath) {\n            const decodedPath = decodeURIComponent(datasetPath || '');\n            const decodedLast = decodeURIComponent(lastImagePath || '');\n            let latestLast = decodedLast;\n            try {\n                const response = await fetch(`${API_BASE}/api/instances/last-image?datasetPath=${encodeURIComponent(decodedPath)}`);\n                if (response.ok) {\n                    const data = await response.json();\n                    if (data.lastImagePath) {\n                        latestLast = data.lastImagePath;\n                    }\n                }\n            } catch (err) {\n                // Ignore fetch errors and fall back to cached data\n            }\n            const url = buildEditorUrl(decodedPath, latestLast);\n            if (!url) {\n                alert('Dataset path is missing.');\n                return;\n            }\n            window.open(url, '_blank');\n        }\n\n        function normalizeStartImagePath(lastImagePath, folderPath) {\n            if (!lastImagePath) {\n                return '';\n            }\n            if (lastImagePath.startsWith(`${folderPath}/`)) {\n                return lastImagePath;\n            }\n            if (lastImagePath.startsWith('images/') && folderPath.endsWith('/images') && folderPath !== 'images') {\n                const datasetPrefix = folderPath.replace(/\\/images$/, '');\n                return `${datasetPrefix}/${lastImagePath}`;\n            }\n            return lastImagePath;\n        }\n\n        async function copyEditorUrl(url) {\n            if (!url) {\n                alert('No URL available to copy.');\n                return;\n            }\n            try {\n                if (navigator.clipboard && navigator.clipboard.writeText) {\n                    await navigator.clipboard.writeText(url);\n                } else {\n                    const temp = document.createElement('textarea');\n                    temp.value = url;\n                    document.body.appendChild(temp);\n                    temp.select();\n                    document.execCommand('copy');\n                    document.body.removeChild(temp);\n                }\n                setStatus('Label editor URL copied to clipboard.');\n            } catch (err) {\n                alert('Failed to copy URL.');\n            }\n        }\n\n        function statusLabel(instance) {\n            const status = (instance.status || 'unknown').toLowerCase();\n            const isOnline = status === 'online';\n            const pillClass = isOnline ? 'online' : 'offline';\n            const label = isOnline ? 'Online' : 'Offline';\n            return `<span class=\"pill ${pillClass}\"><span class=\"dot\"></span>${label}</span>`;\n        }\n\n        function renderInstances() {\n            const grid = document.getElementById('instancesGrid');\n            const emptyState = document.getElementById('emptyState');\n            if (!grid || !emptyState) {\n                return;\n            }\n\n            if (!instances.length) {\n                grid.innerHTML = '';\n                emptyState.style.display = 'block';\n                setStatus('0 instances found.');\n                return;\n            }\n\n            emptyState.style.display = 'none';\n            setStatus(`${instances.length} instance${instances.length === 1 ? '' : 's'} loaded.`);\n            grid.innerHTML = instances.map(instance => {\n                const datasetPath = instance.datasetPath || '';\n                const lastImagePath = instance.lastImagePath || '';\n                const editorUrl = buildEditorUrl(datasetPath, lastImagePath);\n                const isDisabled = !datasetPath;\n                return `\n                    <div class=\"card\">\n                        <div>\n                            <h2>${instance.name || 'Instance'}</h2>\n                            ${statusLabel(instance)}\n                        </div>\n                        <div class=\"meta\">\n                            <div><strong>Dataset:</strong> ${datasetPath || 'Not set'}</div>\n                            <div><strong>Port:</strong> ${instance.port || '-'}</div>\n                        </div>\n                        <div class=\"actions\">\n                            <button class=\"btn\" onclick=\"openLabelEditor('${encodeURIComponent(datasetPath)}', '${encodeURIComponent(lastImagePath)}')\" ${isDisabled ? 'disabled' : ''}>\n                                Open Label Editor\n                            </button>\n                            <button class=\"btn secondary\" onclick=\"copyEditorUrl('${editorUrl}')\" ${editorUrl ? '' : 'disabled'}>\n                                Copy URL\n                            </button>\n                        </div>\n                    </div>\n                `;\n            }).join('');\n        }\n\n        async function refreshInstances() {\n            setStatus('Loading instances...');\n            try {\n                const response = await fetch(`${API_BASE}/api/instances`);\n                const data = await response.json();\n                if (!response.ok) {\n                    throw new Error(data.error || 'Failed to load instances');\n                }\n                instances = Array.isArray(data) ? data : [];\n            } catch (err) {\n                instances = [];\n                setStatus(`Error: ${err.message}`);\n                console.error(err);\n            }\n            renderInstances();\n        }\n\n        async function loadConfig() {\n            try {\n                const response = await fetch(`${API_BASE}/api/config`);\n                if (response.ok) {\n                    config = await response.json();\n                }\n            } catch (err) {\n                config = {};\n            }\n        }\n\n        loadConfig().then(refreshInstances);\n    </script>";

export const metadata = {
  title: "Label Editor Datasets"
};

export default function Page() {
  return (
    <>
      <style dangerouslySetInnerHTML={{ __html: styles }} />
      <div dangerouslySetInnerHTML={{ __html: bodyHtml }} />
      <Script src="/js/label-editor-main.js" strategy="afterInteractive" />
    </>
  );
}
