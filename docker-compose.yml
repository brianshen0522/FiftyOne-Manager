services:
  mongodb:
    image: mongo:7
    container_name: fiftyone-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=fiftyone
    restart: unless-stopped
    command: mongod --quiet

  fiftyone-manager:
    build: .
    container_name: fiftyone-manager_v3
    depends_on:
      - mongodb
    ports:
      - "${MANAGER_PORT:-3000}:${MANAGER_PORT:-3000}"
      - "${PORT_START}-${PORT_END}:${PORT_START}-${PORT_END}"
    volumes:
      - ${DATASET_BASE_PATH}:${DATASET_BASE_PATH}:rw
      - ./instances.json:/app/instances.json
      - pm2-logs:/root/.pm2/logs
      - ./deletion_logs:/app/deletion_logs:rw
    environment:
      - DATASET_BASE_PATH=${DATASET_BASE_PATH}
      - PORT_START=${PORT_START}
      - PORT_END=${PORT_END}
      - MANAGER_PORT=${MANAGER_PORT:-3000}
      - PUBLIC_ADDRESS=${PUBLIC_ADDRESS:-localhost}
      - DEFAULT_IOU_THRESHOLD=${DEFAULT_IOU_THRESHOLD:-0.8}
      - DEFAULT_DEBUG_MODE=${DEFAULT_DEBUG_MODE:-false}
      - FIFTYONE_DATABASE_URI=mongodb://mongodb:27017
      - CVAT_ENABLED=${CVAT_ENABLED:-true}
      - CVAT_URL=${CVAT_URL}
      - CVAT_USERNAME=${CVAT_USERNAME}
      - CVAT_PASSWORD=${CVAT_PASSWORD}
      - CVAT_EMAIL=${CVAT_EMAIL}
      - AVAILABLE_OBB_MODES=${AVAILABLE_OBB_MODES:-rectangle,4point}
    restart: unless-stopped

volumes:
  pm2-logs:
  mongodb-data:
