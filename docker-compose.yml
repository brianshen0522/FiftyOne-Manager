services:
  mongodb:
    image: mongo:7
    container_name: fiftyone-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=fiftyone
    restart: unless-stopped
    command: mongod --quiet

  postgres:
    image: postgres:16
    container_name: fiftyone-postgres
    ports:
      - "5432:5432"
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=fiftyone_manager
      - POSTGRES_USER=fiftyone
      - POSTGRES_PASSWORD=fiftyone
    restart: unless-stopped

  fiftyone-manager:
    build: .
    container_name: fiftyone-manager_v3
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G
    depends_on:
      - mongodb
      - postgres
    ports:
      - "${MANAGER_PORT:-3000}:${MANAGER_PORT:-3000}"
      - "${PORT_START}-${PORT_END}:${PORT_START}-${PORT_END}"
    volumes:
      - ${DATASET_BASE_PATH}:${DATASET_BASE_PATH}:rw
      - pm2-logs:/root/.pm2/logs
      - ./deletion_logs:/app/deletion_logs:rw
    environment:
      - DATASET_BASE_PATH=${DATASET_BASE_PATH}
      - PORT_START=${PORT_START}
      - PORT_END=${PORT_END}
      - MANAGER_PORT=${MANAGER_PORT:-3000}
      - PUBLIC_ADDRESS=${PUBLIC_ADDRESS:-localhost}
      - DEFAULT_IOU_THRESHOLD=${DEFAULT_IOU_THRESHOLD:-0.8}
      - DEFAULT_DEBUG_MODE=${DEFAULT_DEBUG_MODE:-false}
      - LABEL_EDITOR_PRELOAD_COUNT=${LABEL_EDITOR_PRELOAD_COUNT:-20}
      - FIFTYONE_DATABASE_URI=mongodb://mongodb:27017
      - DATABASE_URL=postgresql://fiftyone:fiftyone@postgres:5432/fiftyone_manager
      - AVAILABLE_OBB_MODES=${AVAILABLE_OBB_MODES:-rectangle,4point}
      - DUPLICATE_RULES=${DUPLICATE_RULES:-}
      - DUPLICATE_DEFAULT_ACTION=${DUPLICATE_DEFAULT_ACTION:-move}
      - THUMBNAIL_QUALITY=${THUMBNAIL_QUALITY:-70}
    restart: unless-stopped

volumes:
  pm2-logs:
  mongodb-data:
